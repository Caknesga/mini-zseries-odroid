<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Mini-ZSeries Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1> Mini-ZSeries KontenÃ¼bersicht</h1>

    <div class="account-grid">
        {% for name, balance in accounts.items() %}
     <div class="account-box" id="account-{{ name }}" data-threshold="{{ thresholds[name] }}">
            <h2>Konto {{ name }}</h2>
            <p>Saldo: <strong id="balance-{{ name }}">{{ balance }}</strong> EUR</p>
            

            <input type="number" id="amount-{{ name }}" placeholder="Betrag" min="0" step="1">
            <div class="btn-row">
                <button onclick="updateBalance('{{ name }}', 'deposit')">Einzahlen</button>
                <button onclick="updateBalance('{{ name }}', 'withdraw')">Abheben</button>
            </div>
    
            <p id="status-{{ name }}" class="status"></p>
        </div>
        {% endfor %}
    </div>

    <script>
    async function updateBalance(account, action) {
        const amountInput = document.getElementById(`amount-${account}`);
        const amount = parseFloat(amountInput.value);
        const statusEl = document.getElementById(`status-${account}`);
        const balanceEl = document.getElementById(`balance-${account}`);

        const box = document.getElementById(`account-${account}`);
        const threshold = parseFloat(box.dataset.threshold) || 1000;
        if (amount >= threshold) {
        statusEl.textContent = " MÃ¶glicher Fraud";
        statusEl.style.color = "#da1e28";
        return;
        }

       

        if (isNaN(amount) || amount <= 0) {
            statusEl.textContent = " UngÃ¼ltiger Betrag";
            statusEl.style.color = "#da1e28"; // IBM Red
            return;
        }

        try {
            const response = await fetch(`/${action}`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({account: account, amount: amount})
            });

            const data = await response.json();

            if (response.ok) {
                balanceEl.textContent = data.balance;
                statusEl.textContent = "Erfolgreich!";
                statusEl.style.color = "#198038"; // IBM Green
            } else {
                statusEl.textContent = ` ${data.error}`;
                statusEl.style.color = "#da1e28";
            }
        } catch (error) {
            statusEl.textContent = "Verbindungsfehler";
            statusEl.style.color = "#da1e28";
        }
    }
    
    </script>

<form id="transferForm">
  <label>Von Konto:</label>
  <input type="text" id="fromAccount" placeholder="z. B. Deniz">
  
  <label>Zu Konto:</label>
  <input type="text" id="toAccount" placeholder="z. B. Markus">

  <label>Betrag:</label>
  <input type="number" id="transferAmount" placeholder="Betrag">

  <button type="submit">Transferieren</button>
</form>

<p id="transferResult"></p>
<script>
        document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("transferForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const from = document.getElementById("fromAccount").value;
            const to = document.getElementById("toAccount").value;
            const amount = parseFloat(document.getElementById("transferAmount").value);
            const resultEl = document.getElementById("transferResult");

            try {
            const response = await fetch("/transfer", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ from, to, amount })
            });
            const result = await response.json();

            if (response.ok) {
                resultEl.textContent = ` ${amount} EUR von ${from} nach ${to} Ã¼bertragen.`;
                resultEl.style.color = "#198038";

                // ðŸ”„ Refresh balances
                for (const [acc, balance] of Object.entries(result.balances)) {
                const el = document.getElementById(`balance-${acc}`);
                if (el) el.textContent = balance;
                }
            } else {
                resultEl.textContent = ` ${result.error}`;
                resultEl.style.color = "#da1e28";
            }
            } catch (error) {
            resultEl.textContent = "Fehler bei der Verbindung";
            resultEl.style.color = "#da1e28";
            }
        });
        });
</script>

<h2> Transaction History</h2>
<table id="txTable">
    <tr>
        <th>Timestamp</th>
        <th>Type</th>
        <th>Account</th>
        <th>From</th>
        <th>To</th>
        <th>Amount</th>
        <th>Status</th>
    
    </tr>
</table>

<script>
    async function loadTransactions() {
        const res = await fetch("/transactions");
        const data = await res.json();
        const table = document.getElementById("txTable");

        data.slice().reverse().forEach(tx => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${tx.timestamp}</td>
                <td>${tx.type}</td>
                <td>${tx.account || "-"}</td>
                <td>${tx.from || "-"}</td>
                <td>${tx.to || "-"}</td>
                <td>${tx.amount}</td>
                <td>${tx.status}</td>
                
            `;
            table.appendChild(row);
        });
    }

   setInterval(loadTransactions, 2000);
</script>


</body>
</html>
