<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Mini-ZSeries Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1> Mini-ZSeries  </h1>
 
    <div class="account-grid">
        {% for name, balance in accounts.items() %}
     <div class="account-box" id="account-{{ name }}" data-threshold="{{ thresholds[name] }}">
            <h2>Account {{ name }}</h2>
            <p>Balance: <strong id="balance-{{ name }}">{{ balance }}</strong> EUR</p>
            

            <input type="number" id="amount-{{ name }}" placeholder="Betrag" min="0" step="1">
            <div class="btn-row">
                <button onclick="updateBalance('{{ name }}', 'deposit')">Deposit</button>
                <button onclick="updateBalance('{{ name }}', 'withdraw')">Withdraw</button>
            </div>
    
            <p id="status-{{ name }}" class="status"></p>
        </div>
        {% endfor %}
    </div>

    <script>
    async function updateBalance(account, action) {
        const amountInput = document.getElementById(`amount-${account}`);
        const amount = parseFloat(amountInput.value);
        const statusEl = document.getElementById(`status-${account}`);
        const balanceEl = document.getElementById(`balance-${account}`);

        const box = document.getElementById(`account-${account}`);
        const threshold = parseFloat(box.dataset.threshold) || 1000;
        if (amount >= threshold) {
        statusEl.textContent = "HIGH FRAUD RISK";
        statusEl.style.color = "#da1e28";
        return;
        }

       

        if (isNaN(amount) || amount <= 0) {
            statusEl.textContent = "NOT VALID AMOUNT";
            statusEl.style.color = "#da1e28"; // IBM Red
            return;
        }

        try {
            const response = await fetch(`/${action}`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({account: account, amount: amount})
            });

            const data = await response.json();

            if (response.ok) {
                balanceEl.textContent = data.balance;
                statusEl.textContent = "Successful!";
                statusEl.style.color = "#198038"; // IBM Green
            } else {
                statusEl.textContent = ` ${data.error}`;
                statusEl.style.color = "#da1e28";
            }
        } catch (error) {
            statusEl.textContent = "Connection Error";
            statusEl.style.color = "#da1e28";
        }
    }
    
    </script>


  <form class="transfer" id="transferForm">
    <label>From Account:</label>
    <input type="text" id="fromAccount" placeholder="e.g. Deniz">

    <label>To Account:</label>
    <input type="text" id="toAccount" placeholder="e.g. Markus">

    <label>Amount:</label>
    <input type="number" id="transferAmount" placeholder="Amount">

    <button type="submit" class="btn-primary">Transfer</button>
  </form>

  
  <div class="transaction-section">
    <h2>Transaction History</h2>
    <table id="txTable">
      <thead>
        <tr>
          <th>Time</th>
          <th>Type</th>
          <th>Account</th>
          <th>From</th>
          <th>To</th>
          <th>Amount</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="txBody"></tbody>
    </table>
  </div>
 
</div>

<div class="hardware-btn-container">
    <button onclick="window.location.href='/hardware_monitor'" class="btn-secondary">
      Hardware Monitoring
    </button>
  </div>

<p id="transferResult"></p>
<script>
        document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("transferForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const from = document.getElementById("fromAccount").value;
            const to = document.getElementById("toAccount").value;
            const amount = parseFloat(document.getElementById("transferAmount").value);
            const resultEl = document.getElementById("transferResult");

            try {
            const response = await fetch("/transfer", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ from, to, amount })
            });
            const result = await response.json();

            if (response.ok) {
                resultEl.textContent = ` ${amount} EUR from ${from} to ${to} transferred.`;
                resultEl.style.color = "#198038";

                // ðŸ”„ Refresh balances
                for (const [acc, balance] of Object.entries(result.balances)) {
                const el = document.getElementById(`balance-${acc}`);
                if (el) el.textContent = balance;
                }
            } else {
                resultEl.textContent = ` ${result.error}`;
                resultEl.style.color = "#da1e28";
            }
            } catch (error) {
            resultEl.textContent = "Fehler bei der Verbindung";
            resultEl.style.color = "#da1e28";
            }
        });
        });
</script>






<script>
   let lastTxTimestamp = null;

async function loadTransactions() {
  const res = await fetch("/transactions");
  const data = await res.json();
  if (data.length === 0) return;

  const latest = data[data.length - 1]; // last transaction only

  // Only proceed if this transaction is new
  if (latest.timestamp === lastTxTimestamp) return;
  lastTxTimestamp = latest.timestamp;

  const tbody = document.getElementById("txBody");

  const row = document.createElement("tr");
  row.innerHTML = `
      <td>${latest.timestamp}</td>
      <td>${latest.type}</td>
      <td>${latest.account || "-"}</td>
      <td>${latest.from || "-"}</td>
      <td>${latest.to || "-"}</td>
      <td>${latest.amount}</td>
      <td>${latest.status}</td>
  `;
  tbody.prepend(row);
}

setInterval(loadTransactions, 2000);
</script>
</body>
</html>
